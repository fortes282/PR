
## 1. Systém notifikací — role, zobrazení a ukládání do přehledu

### 1.1 Cíl

Jednoznačně určit, které notifikace se kterým rolím zobrazují a které se ukládají do přehledu notifikací (stránka `/notifications`, API `GET /notifications`).

### 1.2 Role

**ADMIN**, **RECEPTION**, **EMPLOYEE**, **CLIENT** (RBAC v `src/lib/auth/rbac.ts`).

### 1.3 Typy notifikací

- **In-app** — záznam v `store.notifications`, `channel: IN_APP` nebo bez externího odeslání, s `userId` u notifikací pro konkrétního klienta.
- **Bulk odeslané** — např. `POST /notifications/send-bulk`: záznamy s `userId = clientId`, `channel` EMAIL/SMS.
- **Systémové / globální** — pro recepci nebo admina (schválení, upozornění): bez `userId` nebo s `userId` cílového pracovníka.
- **Vázané na entitu** — `appointmentId` nebo `blockId` (připomínka termínu, zrušení).

### 1.4 Pravidla zobrazení a ukládání

| Role     | Co zobrazit v přehledu notifikací | Ukládání do přehledu |
|----------|-----------------------------------|------------------------|
| **CLIENT** | Pouze notifikace kde `userId === currentUser.id`. | Každá notifikace určená klientovi (`userId` = tento klient) se ukládá a zobrazuje v jeho přehledu. |
| **EMPLOYEE** | Pouze notifikace kde `userId === currentUser.id` nebo vztahující se k jeho blokům/termínům (např. `blockId` v jeho blocích). | Notifikace přiřazené zaměstnanci (připomínka jeho termínu, změna) se ukládají a zobrazují. |
| **RECEPTION** | Všechny notifikace (přehled za recepci), volitelně filtrovatelné podle `userId`, `appointmentId`, `blockId`. | Všechny notifikace odeslané klientům (`userId`) + systémové notifikace pro recepci (např. „Čeká schválení odeslání nabídky uvolněného termínu“) se ukládají a zobrazují. |
| **ADMIN** | Stejně jako RECEPTION + systémové notifikace určené pouze adminovi (schválení algoritmu, reporty). | Stejné ukládání jako RECEPTION + notifikace typu „Vyžaduje schválení admina“. |

### 1.5 Backend

`GET /notifications` vrací seznam podle role:

- **CLIENT / EMPLOYEE:** pouze záznamy kde `n.userId === request.user.id` (u EMPLOYEE případně i podle `blockId`/appointment dle modelu).
- **RECEPTION / ADMIN:** všechny notifikace (s volitelným filtrem `userId` / `appointmentId` / `blockId`), včetně odeslaných klientům a systémových výzev ke schválení.

Shrnutí: přehled notifikací zobrazuje každé roli jen jí příslušné záznamy; každá vytvořená notifikace v `store.notifications` se ukládá a zobrazení se řídí výše uvedeným filtrem podle role.

---

## 2. Behaviorální algoritmus — Auto / Manual a maximalizace obsazenosti

### 2.1 Cíl

- Maximalizovat obsazenost: dopředu (dlouhý horizont) i při náhlých výpadcích (zrušení na poslední chvíli).
- U uvolněných termínů: vybrat vhodné klienty (tendence vyplňovat termíny, reaktivita), poslat nabídku (auto nebo po schválení) a při obsazení zvýšit jejich váhu pro další výzvy.

### 2.2 Režimy: Auto vs Manual

- **Auto:** Algoritmus sám vybere klienty a ihned odešle notifikace (e-mail / in-app dle `notificationStrategy`). Bez schvalování.
- **Manual:** Algoritmus vybere klienty a vytvoří návrh (draft). Odešle se výzva ke schválení (e-mail + in-app) adminovi a recepci. Po schválení (jedním z nich) se teprve odešlou notifikace vybraným klientům. Vše se zapisuje do přehledu notifikací (systémové záznamy pro admin/recepci + záznamy pro klienty po odeslání).

Režim může být globální (nastavení v settings) nebo per-akce (např. jen pro danou kampaň uvolněných slotů).

### 2.3 Tok při uvolněném termínu

1. **Trigger:** zrušení rezervace nebo detekce brzy realizovaného volného slotu.
2. **Výběr kandidátů:**  
   Vstup: klienti s behavior profilem, volný slot (čas, služba, místnost).  
   Ranking: hlavně `fillHelperScore`, dále `reactivityScore`, `preferredChannel` a `contentHint` z `buildNotificationStrategy`.  
   Filtry: vyřadit „ignores_notifications“, respektovat `maxPerDay`/`maxPerWeek` a cooldown.  
   Výstup: seznam klientů s prioritou (např. top N nebo nad prahem).
3. **Auto:** odeslat notifikace vybraným klientům a uložit do přehledu.  
   **Manual:** vytvořit záznam Schválení (Approval): které sloty, kterým klientům, jaký text; odeslat adminovi a recepci e-mail + in-app „Čeká schválení: nabídka uvolněných termínů X klientům“; uložit do přehledu. Po schválení odeslat klientům a uložit jejich notifikace.
4. **Po obsazení slotu klientem:** Zaznamenat event `slot_claimed`. Při příštím `computeBehaviorProfile` se zvýší `slotClaimedCount` → vyšší `fillHelperScore` → vyšší váha při dalším výběru.

### 2.4 Datové rozšíření

- **Typ notifikace:** Rozšířit notifikaci o `notificationType` / `purpose`: např. `REMINDER`, `SLOT_OFFER`, `APPROVAL_REQUEST`, `SYSTEM_ALERT`. Umožní filtrovat v přehledu a dodržet pravidla pro role.
- **Schválení (Manual):** Entita např. `SlotOfferApproval`: `id`, `slotIds`/`appointmentIds`, `clientIds`, `messageTemplate`, `status: PENDING | APPROVED | REJECTED`, `createdAt`, `decidedBy`, `decidedAt`. Při vytvoření vytvořit systémové notifikace pro ADMIN/RECEPTION; při APPROVED odeslat klientům a uložit notifikace.
- **Nastavení:** V settings např. `behaviorSlotOfferMode: "auto" | "manual"`, volitelně `approvalNotifyEmails: string[]`.

### 2.5 Další systémy podporující cíl (obsazenost)

- **Waitlist + behavior:** Při uvolnění slotu řadit nejen podle čekacího listu, ale podle `fillHelperScore` + `reactivityScore` a `notificationStrategy`. Nejlepší kandidáty notifikovat první (Auto) nebo nabídnout ke schválení (Manual).
- **Proaktivní brzy realizované sloty:** Pravidelně (cron) hledat sloty blízké realizaci (např. 24–72 h), které jsou volné. Vybrat klienty s vysokým `fillHelperScore` a krátkým `avgBookingLeadTimeHours` a poslat nabídku (auto/manual).
- **Remindery a no-show:** Posílat připomínky podle `notificationStrategy` (kanál, čas, `contentHint`) pro snížení no-show.
- **Re-engagement po zrušení:** Po zrušení kromě nabídky waitlistu/vybraným klientům zařadit klienta do re-engagement (např. „Zrušil jste termín – zde jsou volné alternativy“).
- **Metriky kampaní:** U každé kampaně (nabídka slotů) ukládat režim (auto/manual), počet odeslaných, otevření, konverze (`slot_claimed`) pro vyhodnocení efektivity.
- **Limity:** Respektovat `maxPerDay`/`maxPerWeek` a cooldown z `buildNotificationStrategy`.

---

## 3. Admin log vyhodnocení a oslovení

### 3.1 Účel

V adminu jeden centrální log: všechna behaviorální vyhodnocení a související oslovení — kdo dostal jaké skóre, proč, kdy byl osloven a z jakého důvodu. Pro audit, ladění algoritmu a podporu.

### 3.2 Co se loguje

**A) Záznam vyhodnocení skóre (evaluation)**

Pro každé vyhodnocení profilu klienta ukládat:

| Pole | Popis |
|------|--------|
| `id` | Unikátní ID záznamu |
| `clientId` | ID klienta |
| `clientName` | Jméno klienta (pro filtrování) |
| `evaluatedAt` | Datum a čas vyhodnocení (ISO) |
| `triggerEvent` | Co vyhodnocení spustilo (`booking_completed`, `booking_cancelled`, `manual_refresh`, `scheduled_job`) |
| `reason` | Lidsky čitelný důvod |
| `previousScores` | Předchozí skóre (volitelně): reliabilityScore, cancellationRiskScore, reactivityScore, fillHelperScore |
| `newScores` | Nová skóre po vyhodnocení |
| `scoreChanges` | Volitelně: které skóre se změnilo a o kolik |
| `tagsAdded` | Tagy přidané při tomto vyhodnocení |
| `tagsRemoved` | Tagy odebrány |
| `tagsCurrent` | Aktuální sada tagů po vyhodnocení |

**B) Záznam oslovení (outreach)**

Při každém odeslání notifikace klientovi z algoritmu nebo manuální akce:

| Pole | Popis |
|------|--------|
| `id` | Unikátní ID |
| `clientId` | ID klienta |
| `clientName` | Jméno klienta |
| `sentAt` | Datum a čas odeslání (ISO) |
| `channel` | EMAIL, SMS, PUSH, IN_APP |
| `type` / `purpose` | SLOT_OFFER, REMINDER_UPCOMING, WAITLIST_OFFER, REENGAGE_AFTER_REFUND, MANUAL_BULK, … |
| `reason` | Proč byl klient vybrán |
| `relatedEntityIds` | appointmentId, blockId, approvalId (volitelně) |
| `mode` | auto | manual |
| `outcome` | Volitelně později: opened, clicked, converted, ignored |

### 3.3 Umístění

- Backend: např. tabulky `behavior_evaluation_log` a `behavior_outreach_log` (nebo rozšíření stávajícího „sent communications“).
- API: např. `GET /admin/behavior-log` s parametry pro oba typy záznamů a filtry níže.
- Admin UI: stránka „Behavior / Log“ (záložky „Vyhodnocení“ a „Oslovení“) s tabulkou a filtry.

### 3.4 Kompletní filtrování (admin)

**Log vyhodnocení (evaluations):**

| Filter | Popis | Příklad |
|--------|--------|--------|
| Jméno klienta | Full-text nebo prefix na `clientName` | „Novák“ |
| clientId | Přesné ID klienta | c-123 |
| Typ změny | Co se změnilo | fillHelperScore, reliabilityScore, tag_added, tag_removed, any |
| Konkrétní skóre | Které skóre | Reliability / Cancellation risk / Reactivity / Fill-helper |
| Směr změny | Zvýšení / snížení / jakákoliv | increased / decreased / any |
| Tag | Přidaný nebo přítomný tag | super_substitute, frequently_cancels |
| Trigger event | Co spustilo vyhodnocení | booking_cancelled, slot_claimed, manual_refresh |
| Datum a čas | Rozsah `evaluatedAt` | od – do (date + čas) |
| Období | Presety | Dnes, Posledních 7 dní, 30 dní, Vlastní |

**Log oslovení (outreach):**

| Filter | Popis | Příklad |
|--------|--------|--------|
| Jméno klienta | Full-text nebo prefix | „Novák“ |
| clientId | Přesné ID | c-123 |
| Typ oslovení | purpose / type | SLOT_OFFER, REMINDER_UPCOMING, … |
| Kanál | EMAIL, SMS, PUSH, IN_APP | |
| Režim | auto / manual | |
| Datum a čas | Rozsah `sentAt` | od – do |
| Období | Presety | jako u evaluations |

**Společné:** Řazení podle data (nejnovější / nejstarší), stránkování (limit, offset nebo cursor), volitelně export CSV/Excel.

---

## 4. Reset kompletního skóre klienta (admin)

### 4.1 Požadavek

V adminu možnost u konkrétního klienta **resetovat kompletní behaviorální skóre**, aby byl profil při příštím vyhodnocení jako „od nuly“.

### 4.2 Co reset znamená

- Vymazat nebo vyřadit z výpočtu **behaviorální události** (`BehaviorEvent`) pro daného `clientId` (fyzické smazání nebo soft delete s ohledem na GDPR a audit).
- Při příštím `computeBehaviorProfile(clientId, events, …)` bude `events` pro tohoto klienta prázdné (nebo jen neignorované), takže metriky = default, skóre = výchozí, tagy = žádné, notification strategy = default.

### 4.3 Co nemazat

- Reálné transakční záznamy (rezervace, faktury, návštěvy) nemazat — pouze behavior event store (nebo odvozené/aggregované záznamy pro tohoto klienta).

### 4.4 Implementace

- **API:** Např. `POST /admin/clients/:clientId/behavior-reset` (pouze ADMIN). Volitelně v těle `reason?: string`.
- **Oprávnění:** Pouze ADMIN (např. `behavior:reset` nebo admin-only route).
- **Audit:** Záznam do admin logu: typ „score_reset“, clientId, performedBy, performedAt, reason; volitelně uložit poslední skóre před resetem.
- **Admin UI:** U detailu klienta (nebo v seznamu) tlačítko „Resetovat behaviorální skóre“ s potvrzením (modal: „Opravdu resetovat? Klient bude při příštím vyhodnocení brán jako bez historie.“).

---

## 5. Shrnutí

1. **Notifikace:** Přehled podle role (CLIENT/EMPLOYEE jen vlastní, RECEPTION/ADMIN vše); každá notifikace se ukládá, zobrazení se filtruje dle role.
2. **Algoritmus:** Režimy Auto (okamžité odeslání) a Manual (schválení admin/recepce); výběr dle fillHelperScore/reactivityScore; po obsazení slot_claimed → vyšší váha; podpora waitlistu, proaktivních slotů, reminderů, re-engagementu a metrik.
3. **Admin log:** Log vyhodnocení (kdo, jaké skóre, proč, kdy) a log oslovení (kdo, kdy osloven, proč); kompletní filtrování podle jména, typu změny, typu skóre, data a času, tagů, triggeru, kanálu, režimu.
4. **Reset skóre:** Pouze ADMIN; reset = vymazání/vyřazení behaviorálních událostí klienta; audit a potvrzení v UI.

